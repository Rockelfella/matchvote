<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MatchVote - Benutzerprofil</title>
  <link rel="stylesheet" href="/app.css">
  <link rel="stylesheet" href="/mv-ui.css">
</head>
<body class="mv-page mv-user mv-theme-violet">
    <nav class="topbar mv-topbar">
    <div class="brand">
      <button class="logo mv-menu-toggle mv-icon-btn mv-icon-btn--md" id="mvMenuToggle" type="button" aria-label="Menü öffnen" aria-expanded="false">MV</button>
      <div class="brand-text">
        <div class="mv-brand-title">Profil</div>
        <small>Account</small>
      </div>
    </div>
    <div class="nav-user mv-top-actions">
      <a class="icon-btn" href="ratings.html" title="Zurück" aria-label="Zurück">←</a>
    </div>
  </nav>

  <div class="mv-drawer-overlay" id="mvDrawerOverlay"></div>
  <aside class="mv-drawer" id="mvDrawer" aria-label="Navigation">
    <div class="mv-drawer-header">
      <div class="logo">MV</div>
      <div>
        <div class="mv-drawer-title">MatchVote</div>
        <div class="mv-drawer-sub">Szenenbewertung</div>
      </div>
    </div>
    <nav class="mv-drawer-nav">
      <a href="index.html">Start</a>
      <a href="ratings.html">Bewertungen</a>
      <a href="roadmap.html">Roadmap</a>
      <a href="admin.html">Admin</a>
      <a href="user.html" class="active">Profil</a>
      <a href="privacy.html">Datenschutz</a>
      <a href="impressum.html">Impressum</a>
      <a href="credits.html">Credits</a>
      <a href="#" data-logout>Abmelden</a>
    </nav>
  </aside>

    <main class="mv-content mv-narrow">
    <section class="card profile-hero">
      <h1>Profil</h1>
      <div class="profile-email" id="profileName">Angemeldet</div>
      <div class="profile-note" id="profileStatus">Profilinformationen werden geladen.</div>
      <div class="profile-badges">
        <span class="pill" id="profileAdminBadge" style="display:none;">Admin</span>
        <span class="pill" id="profileActiveBadge" style="display:none;">Aktiv</span>
      </div>
    </section>

    <section class="card">
      <div class="section-title">
        <h2>Kontodetails</h2>
      </div>
      <div class="profile-list" id="profileDetails"></div>
    </section>

    <section class="card">
      <div class="section-title">
        <h2>Aktionen</h2>
        <p>Abmelden oder zurück zu Bewertungen.</p>
      </div>
      <div class="actions">
        <a class="btn secondary" href="ratings.html">Zurück zu Bewertungen</a>
        <button id="logoutBtn" type="button" class="btnDanger">Abmelden</button>
      </div>
    </section>

    <section class="card">
      <div class="section-title">
        <h2>Konto löschen</h2>
        <p>Unwiderruflich: Dein Konto und deine Bewertungen werden entfernt.</p>
      </div>
      <div class="muted mv-gap-top">Alle abgegeben Bewertungen werden zusammen mit dem Account gelöscht.</div>
      <label class="mv-gap-top">Bestätigung</label>
      <div class="mv-inline-start">
        <input id="deleteConfirmCheck" type="checkbox" />
        <span>Ich möchte das Konto <strong id="deleteEmailLabel">dieser E-Mail</strong> dauerhaft löschen.</span>
      </div>
      <div class="actions mv-gap-top">
        <button id="deleteAccountBtn" type="button" class="btnDanger" disabled>Konto dauerhaft löschen</button>
      </div>
      <div class="muted mv-gap-top" id="deleteStatus"></div>
    </section>
  </main>

  <footer>
    <div class="footer-links">
      <a href="impressum.html">Impressum</a>
    </div>
    &copy; MatchVote
    <span class="muted">·</span>
    <a href="privacy.html">Datenschutz</a>
    <span class="muted">·</span>
    <a href="credits.html">Credits</a>
  </footer>

<script>
  function getAccessToken(){ return localStorage.getItem("mv_access_token") || ""; }
  function requireLogin(){
    const next = encodeURIComponent("user.html");
    location.replace(`/auth.html?next=${next}`);
  }
  (function guard(){
    if (!getAccessToken()) requireLogin();
  })();

  function getApiBase(){ return localStorage.getItem("mv_api_base") || "/api"; }
  function normalizeBase(v){
    v = (v || "").trim();
    if (!v) return "/api";
    if (v.endsWith("/")) v = v.slice(0,-1);
    return v;
  }
  async function apiFetch(path, options = {}) {
    const base = getApiBase();
    const url = normalizeBase(base) + path;
    const token = getAccessToken();
    const headers = new Headers(options.headers || {});
    if (token) headers.set("Authorization", `Bearer ${token}`);
    if (options.body && !headers.has("Content-Type")) headers.set("Content-Type","application/json");
    const res = await fetch(url, { ...options, headers });
    if (res.status === 401 || res.status === 403) {
      localStorage.removeItem("mv_access_token");
      requireLogin();
    }
    const txt = await res.text();
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch { data = txt; }
    return { res, data, url };
  }

  function decodeJwtPayload(token) {
    if (!token) return null;
    const part = token.split(".")[1];
    if (!part) return null;
    const normalized = part.replace(/-/g, "+").replace(/_/g, "/");
    const padded = normalized + "===".slice((normalized.length + 3) % 4);
    try { return JSON.parse(atob(padded)); } catch { return null; }
  }

  function setDetailGrid(containerId, rows) {
    const el = document.getElementById(containerId);
    if (!el) return;
    el.innerHTML = "";
    if (!rows || !rows.length) return;
    for (const row of rows) {
      const item = document.createElement("div");
      item.className = "detail-item";
      const label = document.createElement("div");
      label.className = "detail-label";
      label.textContent = row.label;
      const value = document.createElement("div");
      value.className = "detail-value";
      value.textContent = (row.value === null || row.value === undefined || row.value === "") ? "-" : String(row.value);
      item.appendChild(label);
      item.appendChild(value);
      el.appendChild(item);
    }
  }

  function getPreferredLanguage() {
    return (localStorage.getItem("mv_lang") || navigator.language || "de").toLowerCase();
  }

  function getLocale() {
    const lang = getPreferredLanguage();
    return lang.startsWith("de") ? "de-DE" : "en-US";
  }

  function formatDateTime(value) {
    if (!value) return "-";
    const dt = new Date(value);
    if (Number.isNaN(dt.getTime())) return "-";
    return dt.toLocaleString(getLocale());
  }

  function getMemberSince(data) {
    if (!data) return "-";
    return formatDateTime(data.first_login_at || data.created_at);
  }

  function getLabelMap() {
    const lang = getPreferredLanguage();
    if (lang.startsWith("de")) {
      return {
        email: "E-Mail",
        lastLogin: "Letzter Login",
        firstLogin: "Mitglied seit",
        active: "Aktiv",
        admin: "Admin",
        yes: "ja",
        no: "nein",
        unavailable: "nicht verfügbar",
      };
    }
    return {
      email: "Email",
      lastLogin: "Last Login",
      firstLogin: "Member since",
      active: "Active",
      admin: "Admin",
      yes: "yes",
      no: "no",
      unavailable: "not available",
    };
  }

  function formatBool(value, labels) {
    if (value === true) return labels.yes;
    if (value === false) return labels.no;
    return "-";
  }

    async function loadProfile() {
    const token = getAccessToken();
    const payload = decodeJwtPayload(token) || {};
    const lastEmail = localStorage.getItem("mv_last_login_email") || "";
    const adminBadge = document.getElementById("profileAdminBadge");
    const activeBadge = document.getElementById("profileActiveBadge");

    try {
      const r = await apiFetch("/me");
      const data = r.data && typeof r.data === "object" ? r.data : null;
      const email = data && data.email ? data.email : (lastEmail || "");
      if (email) localStorage.setItem("mv_last_login_email", email);
      document.getElementById("profileName").textContent = email || "Angemeldet";
      document.getElementById("profileStatus").textContent = data && data.is_active === false
        ? "Konto deaktiviert."
        : "Profil geladen.";
      const deleteLabel = document.getElementById("deleteEmailLabel");
      if (deleteLabel) deleteLabel.textContent = email || "dieser E-Mail";

      if (adminBadge) adminBadge.style.display = (data && data.is_admin) ? "inline-flex" : "none";
      if (activeBadge) activeBadge.style.display = (data && data.is_active) ? "inline-flex" : "none";

      const labels = getLabelMap();
      setDetailGrid("profileDetails", [
        { label: labels.email, value: email || labels.unavailable },
        { label: labels.lastLogin, value: formatDateTime(data && data.last_login_at) },
        { label: labels.firstLogin, value: getMemberSince(data) },
        { label: labels.active, value: data ? formatBool(data.is_active, labels) : "-" },
        { label: labels.admin, value: data ? formatBool(data.is_admin, labels) : "-" }
      ]);
    } catch (e) {
      document.getElementById("profileStatus").textContent = "Profilinformationen nicht verfügbar.";
      if (adminBadge) adminBadge.style.display = "none";
      if (activeBadge) activeBadge.style.display = "none";
      const deleteLabel = document.getElementById("deleteEmailLabel");
      if (deleteLabel) deleteLabel.textContent = lastEmail || "dieser E-Mail";

      const labels = getLabelMap();
      setDetailGrid("profileDetails", [
        { label: labels.email, value: lastEmail || labels.unavailable },
        { label: labels.lastLogin, value: "-" },
        { label: labels.firstLogin, value: "-" },
        { label: labels.active, value: "-" },
        { label: labels.admin, value: "-" }
      ]);
    }
  }

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("mv_access_token");
    requireLogin();
  });

  function setDeleteStatus(msg) {
    const el = document.getElementById("deleteStatus");
    if (el) el.textContent = msg || "";
  }

  function clearAuthStorage() {
    localStorage.removeItem("mv_access_token");
    localStorage.removeItem("mv_last_login_email");
    sessionStorage.removeItem("mv_access_token");
  }

  async function deleteAccount() {
    const check = document.getElementById("deleteConfirmCheck");
    if (!check || !check.checked) {
    setDeleteStatus("Bitte die Bestätigung setzen.");
      return;
    }

    if (!confirm("Dieser Vorgang löscht dein Konto dauerhaft. Fortfahren?")) {
      setDeleteStatus("Abgebrochen.");
      return;
    }

    setDeleteStatus("Konto wird gelöscht...");
    const r = await apiFetch("/me", { method: "DELETE" });
    if (r.res && r.res.status === 204) {
      setDeleteStatus("Benutzer und Bewertungen gelöscht.");
      clearAuthStorage();
      setTimeout(() => location.replace("auth.html"), 800);
      return;
    }

    const detail = (r.data && typeof r.data === "object" && r.data.detail) ? r.data.detail : r.data;
    setDeleteStatus(`Löschen fehlgeschlagen: ${detail || "Unbekannter Fehler"}`);
  }

  function wireDeleteConfirm() {
    const check = document.getElementById("deleteConfirmCheck");
    const btn = document.getElementById("deleteAccountBtn");
    if (!check || !btn) return;
    const update = () => { btn.disabled = !check.checked; };
    check.addEventListener("change", update);
    update();
  }

  document.getElementById("deleteAccountBtn").addEventListener("click", deleteAccount);

  loadProfile();
  wireDeleteConfirm();
</script>
  <script src="/app-nav.js"></script>
</body>
</html>










